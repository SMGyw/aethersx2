name: iOS Build Test
on: [push, pull_request]

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install CMake and Dependencies
        run: |
          brew install cmake ninja

      - name: Configure CMake for iOS
        run: |
          mkdir build
          cd build
          cmake .. -DCMAKE_SYSTEM_NAME=iOS \
                   -DCMAKE_OSX_SYSROOT=iphoneos \
                   -DCMAKE_OSX_ARCHITECTURES=arm64 \
                   -DPLATFORM=ios \
                   -DUSE_SYSTEM_LIBS=OFF \
                   -DENABLE_SOUNDTOUCH=OFF \
                   -DSOUNDTOUCH_FOUND=FALSE \
                   -DCMAKE_DISABLE_FIND_PACKAGE_SoundTouch=TRUE \
                   --no-warn-unused-cli

      - name: Build Core
        run: |
          cd build
          # Clear any old cache and force ARM flags during build
          cmake . -DCMAKE_OSX_ARCHITECTURES="arm64" \
                  -DCMAKE_CXX_FLAGS="-mno-sse -mno-sse2 -U__SSE__ -U__SSE2__" \
                  -DCMAKE_C_FLAGS="-mno-sse -mno-sse2 -U__SSE__ -U__SSE2__"
          
          # Now build
          cmake --build . --config Release