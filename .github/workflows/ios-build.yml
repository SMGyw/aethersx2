name: iOS Build Test
on: [push, pull_request]

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install CMake and Dependencies
        run: |
          brew install cmake ninja

      - name: Create Dummy wxWidgets Headers
        run: |
          mkdir -p dummy_wx/wx
          touch dummy_wx/wx/string.h
          touch dummy_wx/wx/log.h
          touch dummy_wx/wx/thread.h
          touch dummy_wx/wx/gdicmn.h
          touch dummy_wx/wx/msgdlg.h
          touch dummy_wx/wx/app.h
          touch dummy_wx/wx/confbase.h
          touch dummy_wx/wx/fileconf.h
          touch dummy_wx/wx/event.h

      - name: Configure CMake
        run: |
          rm -rf build
          mkdir -p build
          export IOS_SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)
          echo "Current iOS SDK Path: $IOS_SDK_PATH"
          
          cmake -S . -B build \
            -G "Unix Makefiles" \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=$IOS_SDK_PATH \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_WXWIDGETS=OFF \
            -DPCSX2_CORE=ON \
            -DENABLE_SETCAP=OFF

      - name: Build Core
        run: |
          # 1. CLEAN RESET
          git checkout .
          git clean -fd
          rm -rf build && mkdir build
          mkdir -p dummy_wx/wx
          export LC_CTYPE=C
          export LANG=C
          
          # 2. THE ZLIB BYPASS (Keeping the fix that worked)
          if [ -d "3rdparty/libchdr/libchdr/deps/zlib-1.2.11" ]; then
            echo "cmake_minimum_required(VERSION 3.10)" > 3rdparty/libchdr/libchdr/deps/zlib-1.2.11/CMakeLists.txt
            echo "project(zlib_dummy)" >> 3rdparty/libchdr/libchdr/deps/zlib-1.2.11/CMakeLists.txt
            echo "add_library(zlib INTERFACE)" >> 3rdparty/libchdr/libchdr/deps/zlib-1.2.11/CMakeLists.txt
          fi

          # 3. NEUTRALIZATION
          echo "// Empty" > common/GL/ContextAGL.mm
          echo "// Empty" > 3rdparty/cubeb/src/cubeb_resampler.cpp
          echo "// Empty" > 3rdparty/cubeb/src/cubeb_audiounit.cpp

          # 4. SUPER BRIDGE HEADER (Fixing 31% Errors)
          cat <<EOF > dummy_wx/wx_bridge.h
          #pragma once
          #include <string>
          #include <vector>
          #include <iostream>

          // Force wxString to be exactly std::string to avoid redefinition errors
          #ifndef WX_BRIDGE_H
          #define WX_BRIDGE_H
          
          typedef std::string wxString;

          #ifndef wxT
          #define wxT(x) x
          #endif
          #ifndef _
          #define _(x) x
          #endif
          
          #define wxEmptyString std::string("")
          #define wxLogMessage(...) printf(__VA_ARGS__)
          #define wxLogStatus(...) printf(__VA_ARGS__)
          #define wxLogWarning(...) printf(__VA_ARGS__)
          #define wxLogError(...) printf(__VA_ARGS__)
          #define wxUnusedVar(x) (void)x

          // Dummy thread/mutex classes to satisfy common/Threading.h
          class wxThread { public: virtual ~wxThread() {} virtual void* Entry() = 0; };
          class wxMutex { public: void Lock() {} void Unlock() {} };
          class wxCriticalSection { public: void Enter() {} void Leave() {} };
          #endif
          EOF

          # 5. MOCK WX HEADERS (Including thread.h now)
          for h in tokenzr.h string.h log.h setup.h intl.h crt.h msgdlg.h filefn.h config.h thread.h; do
            echo "#include \"../wx_bridge.h\"" > dummy_wx/wx/$h
          done

          cd build
          
          # 6. CONFIGURE
          cmake .. -DCMAKE_BUILD_TYPE=Release \
                   -DUSE_CUBEB=OFF -DBUILD_CUBEB=OFF \
                   -DUSE_WXWIDGETS=OFF -DUSE_OPENGL=OFF -DUSE_VULKAN=ON \
                   -DCMAKE_CXX_FLAGS="-I${GITHUB_WORKSPACE}/dummy_wx -include ${GITHUB_WORKSPACE}/dummy_wx/wx_bridge.h -DwxString=std::string" \
                   -DCMAKE_C_FLAGS="-I${GITHUB_WORKSPACE}/dummy_wx" \
                   -DPCSX2_USE_PCH=OFF

          # 7. STRIP INTEL FLAGS
          find . -name "*.make" -exec sed -i '' 's/-mfpmath=sse//g' {} +
          find . -name "*.make" -exec sed -i '' 's/-msse[^ ]*//g' {} +
          
          # 8. START BUILD
          cmake --build . --config Release -- -j $(sysctl -n hw.logicalcpu)