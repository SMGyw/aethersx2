name: iOS Build Test
on: [push, pull_request]

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install CMake and Dependencies
        run: |
          brew install cmake ninja

      - name: Configure CMake for iOS
        run: |
          mkdir build
          cd build
          cmake .. -DCMAKE_SYSTEM_NAME=iOS \
                   -DCMAKE_OSX_SYSROOT=iphoneos \
                   -DCMAKE_OSX_ARCHITECTURES=arm64 \
                   -DPLATFORM=ios \
                   -DUSE_SYSTEM_LIBS=OFF \
                   -DENABLE_SOUNDTOUCH=OFF \
                   -DSOUNDTOUCH_FOUND=FALSE \
                   -DCMAKE_DISABLE_FIND_PACKAGE_SoundTouch=TRUE \
                   --no-warn-unused-cli

      - name: Build Core
        run: |
          cd build
          # This command will find all references to sse in the generated build files and DELETE them
          grep -r "-msse" . -l | xargs sed -i '' 's/-msse//g' || true
          grep -r "-msse2" . -l | xargs sed -i '' 's/-msse2//g' || true
          grep -r "sse" . -l | xargs sed -i '' 's/sse//g' || true
          
          # Now build normally
          cmake --build . --config Release