name: iOS Build Test
on: [push, pull_request]

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install CMake and Dependencies
        run: |
          brew install cmake ninja

      - name: Create Dummy wxWidgets Headers
        run: |
          mkdir -p dummy_wx/wx
          touch dummy_wx/wx/string.h
          touch dummy_wx/wx/log.h
          touch dummy_wx/wx/thread.h
          touch dummy_wx/wx/gdicmn.h
          touch dummy_wx/wx/msgdlg.h
          touch dummy_wx/wx/app.h
          touch dummy_wx/wx/confbase.h
          touch dummy_wx/wx/fileconf.h
          touch dummy_wx/wx/event.h

      - name: Configure CMake
        run: |
          rm -rf build
          mkdir -p build
          export IOS_SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)
          echo "Current iOS SDK Path: $IOS_SDK_PATH"
          
          cmake -S . -B build \
            -G "Unix Makefiles" \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=$IOS_SDK_PATH \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_WXWIDGETS=OFF \
            -DPCSX2_CORE=ON \
            -DENABLE_SETCAP=OFF

      - name: Build Core
        run: |
          # 1. Start Fresh
          rm -rf build && mkdir build
          mkdir -p dummy_wx/wx
          
          # 2. Kill the macOS/GL files once and for all
          # We use .cpp extension to trick the compiler into ignoring Objective-C logic
          echo "// Empty" > common/GL/ContextAGL.mm
          echo "// Empty" > common/GL/ContextAGL.h
          
          # 3. Patch zlib (Keeping our 20% fix)
          find 3rdparty/libchdr/libchdr/deps/zlib-1.2.11 -name "zconf.h" -exec sed -i '' 's/#ifdef HAVE_FDOPEN/#if 0/g' {} +
          sed -i '' '1i\
          #define NO_FDOPEN
          ' 3rdparty/libchdr/libchdr/deps/zlib-1.2.11/zutil.c

          # 4. Create Bridge Header
          cat <<EOF > dummy_wx/wx_bridge.h
          #pragma once
          #include <string>
          #include <stdarg.h>
          #include <algorithm>
          class wxString : public std::string {
          public:
              using std::string::string;
              wxString() : std::string("") {}
              wxString(const std::string& s) : std::string(s) {}
              wxString(const char* s) : std::string(s ? s : "") {}
              const char* c_str() const { return std::string::c_str(); }
              bool IsEmpty() const { return empty(); }
              void Clear() { clear(); }
              wxString Lower() const { wxString s = *this; std::transform(s.begin(), s.end(), s.begin(), ::tolower); return s; }
              bool StartsWith(const std::string& prefix) const { return this->compare(0, prefix.length(), prefix) == 0; }
              static wxString Format(const char* fmt, ...) {
                  char buf[4096]; va_list args; va_start(args, fmt);
                  vsnprintf(buf, sizeof(buf), fmt, args); va_end(args);
                  return wxString(buf);
              }
          };
          #define wxT(x) x
          #define _(x) x
          EOF

          cd build
          
          # 5. Configure with extra bypasses
          cmake .. -DCMAKE_BUILD_TYPE=Release \
                   -DUSE_CUBEB=OFF -DBUILD_CUBEB=OFF \
                   -DUSE_WXWIDGETS=OFF -DUSE_OPENGL=OFF \
                   -DHAVE_FDOPEN=0 -DNO_FDOPEN=1 \
                   -DPCSX2_USE_PCH=OFF -DCLANG_ENABLE_PCH=OFF

          # 6. SURGERY: Force CMake to treat .mm as a dummy C++ file
          # This prevents it from trying to link macOS-only Frameworks
          echo "Force-disabling ContextAGL in build system..."
          find . -name "build.make" -exec sed -i '' 's/ContextAGL.mm.o/ /g' {} +
          find . -name "flags.make" -exec sed -i '' 's/-x objective-c++/ /g' {} +

          # 7. Post-Configure Cleanup (PCH & SSE)
          find . -name "*.make" -exec sed -i '' 's/-include-pch [^ ]*//g' {} +
          find . -name "flags.make" -exec sed -i '' 's/-include-pch [^ ]*//g' {} +
          find . -name "*.make" -exec sed -i '' 's/-mfpmath=sse//g' {} +
          find . -name "flags.make" -exec sed -i '' 's/-mfpmath=sse//g' {} +

          # 8. Inject Bridge
          if [ -d "common/CMakeFiles/common.dir" ]; then
            sed -i '' "s|CXX_FLAGS = |CXX_FLAGS = -include ${GITHUB_WORKSPACE}/dummy_wx/wx_bridge.h |" common/CMakeFiles/common.dir/flags.make
          fi

          # 9. Build
          cmake --build . --config Release -- -j $(sysctl -n hw.logicalcpu)