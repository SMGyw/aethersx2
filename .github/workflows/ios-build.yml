name: iOS Build Test
on: [push, pull_request]

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install CMake and Dependencies
        run: |
          brew install cmake ninja

      - name: Create Dummy wxWidgets Headers
        run: |
          mkdir -p dummy_wx/wx
          touch dummy_wx/wx/string.h
          touch dummy_wx/wx/log.h
          touch dummy_wx/wx/thread.h
          touch dummy_wx/wx/gdicmn.h
          touch dummy_wx/wx/msgdlg.h
          touch dummy_wx/wx/app.h
          touch dummy_wx/wx/confbase.h
          touch dummy_wx/wx/fileconf.h
          touch dummy_wx/wx/event.h

      - name: Configure CMake
        run: |
          rm -rf build
          mkdir -p build
          export IOS_SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)
          echo "Current iOS SDK Path: $IOS_SDK_PATH"
          
          cmake -S . -B build \
            -G "Unix Makefiles" \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=$IOS_SDK_PATH \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_WXWIDGETS=OFF \
            -DPCSX2_CORE=ON \
            -DENABLE_SETCAP=OFF

      - name: Build Core
        run: |
          # 1. Clean environment
          rm -rf build && mkdir build
          mkdir -p dummy_wx/wx

          # 2. Fix external dependencies
          find 3rdparty/libchdr/libchdr/deps/zlib-1.2.11 -name "zutil.h" -exec sed -i '' '/#.*define.*fdopen/d' {} +
          echo "// Empty" > 3rdparty/cubeb/src/cubeb_resampler.cpp
          echo "// Empty" > 3rdparty/cubeb/src/cubeb_audiounit.cpp
          echo "// Empty" > common/GL/ContextAGL.mm

          # 3. Create the "Alias Bridge" (Fixing the 4 core errors)
          cat <<EOF > dummy_wx/wx/string.h
          #pragma once
          #include <string>
          #include <stdarg.h>

          // Use alias instead of inheritance to avoid template issues
          typedef std::string wxString;

          // Provide missing wxWidgets-like functionality as inline helpers
          inline wxString wxStringFormat(const char* fmt, ...) {
              char buf[2048]; va_list args; va_start(args, fmt);
              vsnprintf(buf, sizeof(buf), fmt, args); va_end(args);
              return std::string(buf);
          }

          #define wxEmptyString std::string("")
          #define wxT(x) x
          #define _(x) x
          EOF

          # Create other required mock headers
          echo "#pragma once" > dummy_wx/wx/intl.h
          echo "#define _(x) x" >> dummy_wx/wx/intl.h
          echo "#define wxTRANSLATE(x) x" >> dummy_wx/wx/intl.h
          touch dummy_wx/wx/tokenzr.h dummy_wx/wx/log.h
          
          # 4. Patch Source: Force the code to use our std::string alias
          # This removes the conflicting internal typedefs that cause the 32% hang
          find common -type f \( -name "*.h" -o -name "*.cpp" \) -exec sed -i '' 's/typedef std::string wxString;/\/\/ removed/g' {} +
          # Replace any call to wxString::Format with our helper
          find common -type f \( -name "*.h" -o -name "*.cpp" \) -exec sed -i '' 's/wxString::Format/wxStringFormat/g' {} +

          cd build
          
          # 5. Configure CMake
          cmake .. -DCMAKE_BUILD_TYPE=Release \
                   -DUSE_CUBEB=OFF -DBUILD_CUBEB=OFF \
                   -DUSE_OPENGL=OFF -DUSE_VULKAN=ON \
                   -DUSE_WXWIDGETS=OFF -DHAVE_FDOPEN=1

          # 6. Final Intel Flag Cleanup
          find . -type f -name "*.make" -exec sed -i '' 's/-mfpmath=sse//g' {} +
          find . -type f -name "flags.make" -exec sed -i '' 's/-mfpmath=sse//g' {} +

          # 7. Run Build
          cmake --build . --config Release -- -j $(sysctl -n hw.logicalcpu)