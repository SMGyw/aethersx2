name: iOS Build Test
on: [push, pull_request]

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install CMake and Dependencies
        run: |
          brew install cmake ninja

      - name: Configure CMake
        run: |
          # 1. Clean any old configuration to prevent cache errors
          rm -rf build
          mkdir -p build
          
          # 2. Get the ABSOLUTE path of the iOS SDK
          export IOS_SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)
          echo "Current iOS SDK Path: $IOS_SDK_PATH"
          
          # 3. Run CMake with the absolute path
          cmake -S . -B build \
            -G "Unix Makefiles" \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=$IOS_SDK_PATH \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_WXWIDGETS=OFF \
            -DPCSX2_CORE=ON \
            -DENABLE_SETCAP=OFF

      - name: Build Core
        run: |
          cd build
          # 1. Clean up the generated build files to remove the 'sse' math unit
          echo "Cleaning up invalid ARM flags..."
          find . -type f -name "*.make" -exec sed -i '' 's/-mfpmath=sse//g' {} +
          find . -type f -name "flags.make" -exec sed -i '' 's/-mfpmath=sse//g' {} +
          find . -type f -name "link.txt" -exec sed -i '' 's/-mfpmath=sse//g' {} +
          
          # 2. Start the build process
          echo "Starting build..."
          cmake --build . --config Release