name: iOS Build Test
on: [push, pull_request]

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install CMake and Dependencies
        run: |
          brew install cmake ninja

      - name: Create Dummy wxWidgets Headers
        run: |
          mkdir -p dummy_wx/wx
          touch dummy_wx/wx/string.h
          touch dummy_wx/wx/log.h
          touch dummy_wx/wx/thread.h
          touch dummy_wx/wx/gdicmn.h
          touch dummy_wx/wx/msgdlg.h
          touch dummy_wx/wx/app.h
          touch dummy_wx/wx/confbase.h
          touch dummy_wx/wx/fileconf.h
          touch dummy_wx/wx/event.h

      - name: Configure CMake
        run: |
          rm -rf build
          mkdir -p build
          export IOS_SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)
          echo "Current iOS SDK Path: $IOS_SDK_PATH"
          
          cmake -S . -B build \
            -G "Unix Makefiles" \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=$IOS_SDK_PATH \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_WXWIDGETS=OFF \
            -DPCSX2_CORE=ON \
            -DENABLE_SETCAP=OFF

      - name: Build Core
        run: |
          # 1. Clean Environment
          rm -rf build && mkdir build
          export LC_CTYPE=C
          export LANG=C
          
          # 2. SOURCE LEVEL SURGERY (The "No-Bridge" Strategy)
          # Instead of a file, we inject the macros directly into every .cpp file
          echo "Injecting raw macros into source files..."
          find common core -name "*.cpp" -exec sed -i '' '1i\
          #include <string>\
          #include <stdarg.h>\
          #include <algorithm>\
          #ifndef WX_MOCK_H\
          #define WX_MOCK_H\
          using wxString = std::string;\
          #define wxT(x) x\
          #define _(x) x\
          #define wxEmptyString std::string("")\
          #define wxLogMessage(...) printf(__VA_ARGS__)\
          #define wxLogStatus(...) printf(__VA_ARGS__)\
          #define wxLogWarning(...) printf(__VA_ARGS__)\
          #define wxLogError(...) printf(__VA_ARGS__)\
          #define wxLogDebug(...) printf(__VA_ARGS__)\
          #define wxPrintf(...) printf(__VA_ARGS__)\
          #define wxUnusedVar(x) (void)x\
          #endif
          ' {} +

          # 3. FIX VirtualMemory.cpp (iOS doesn't support Mach VM the same way as macOS)
          # We force it to use standard posix_memalign if it's struggling
          sed -i '' 's/#ifdef __APPLE__/#ifdef TARGET_OS_IPHONE_STUB/g' common/VirtualMemory.cpp

          # 4. Remove macOS dependencies from CMake
          sed -i '' '/ContextAGL.mm/d' common/CMakeLists.txt || true
          echo "void stub_audio() {}" > 3rdparty/cubeb/src/cubeb_resampler.cpp

          cd build
          
          # 5. Configure with Aggressive Flags
          cmake .. -DCMAKE_BUILD_TYPE=Release \
                   -DUSE_CUBEB=OFF -DBUILD_CUBEB=OFF \
                   -DUSE_WXWIDGETS=OFF -DUSE_OPENGL=OFF -DUSE_VULKAN=ON \
                   -DCMAKE_C_FLAGS="-DHAVE_FDOPEN=0 -Dfdopen=z_ios_fdopen" \
                   -DCMAKE_CXX_FLAGS="-DHAVE_FDOPEN=0 -Dfdopen=z_ios_fdopen" \
                   -DPCSX2_USE_PCH=OFF -DCLANG_ENABLE_PCH=OFF -DENABLE_PCH=OFF \
                   -DCMAKE_DISABLE_PRECOMPILED_HEADERS=ON

          # 6. Global Build System Cleanup
          find . -name "flags.make" -exec sed -i '' 's/-x objective-c++/ /g' {} +
          find . -name "flags.make" -exec sed -i '' 's/-include-pch [^ ]*//g' {} +
          find . -name "flags.make" -exec sed -i '' 's/-mfpmath=sse//g' {} +
          find . -name "build.make" -exec sed -i '' '/cmake_pch.hxx.pch/d' {} +

          # 7. Start Build
          cmake --build . --config Release -- -j $(sysctl -n hw.logicalcpu)